<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSD Collection Tracker — Public View</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root {
      --bg:#0e0f14; --panel:#171821; --muted:#9aa0b4; --accent:#81689D; --accent-2:#FFD0EC; --cell:#121219;
      --radius:12px; --gap:12px;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body {
      height:100%; margin:0;
      background:linear-gradient(180deg,#0b0c10 0%, #0e0f14 100%);
      color:#e6e7ee;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .wrap {
      width:100%;
      max-width:1200px;
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    h1 { color:var(--accent); font-size:20px; margin:0 0 4px 0; text-align:center; }
    .muted { color:var(--muted); font-size:13px; text-align:center; }

    .panel {
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
      padding:16px;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,0.03);
      overflow:auto;
    }

    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:900px;
    }
    th, td {
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      text-align:left;
      white-space:nowrap;
    }
    thead th {
      position:sticky; top:0;
      background:linear-gradient(180deg, rgba(20,20,28,0.9), rgba(18,18,22,0.9));
      backdrop-filter:blur(4px);
      z-index:2;
    }
    td.name { font-weight:600; }
    th.name { width:200px; }
    .row-total { font-weight:700; color:var(--accent-2); }
    tfoot td { font-weight:700; border-top:1px solid rgba(255,255,255,0.04); }
  </style>
</head>
<body>
  <div class="wrap">
    <div>
      <h1>SSD Collection Tracker</h1>
      <div class="muted small">Public view (auto-updates)</div>
    </div>

    <div class="panel">
      <table id="publicTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
        <tfoot id="tableFoot"></tfoot>
      </table>
    </div>
  </div>

  <script>
    const LS_KEY = 'ssd-collection-2025-10';
    let dates = [], students = [], showTotals = false;

    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const tableFoot = document.getElementById('tableFoot');

    function fmtDateShort(d){ return new Date(d).toLocaleDateString(undefined,{day:'2-digit',month:'short'}); }
    function parseNumber(str){
      if(!str) return NaN;
      const s = String(str).replace(/\./g,'').replace(/,/g,'.').trim();
      return Number(s);
    }
    function formatNumber(n){
      if(n===''||n==null||isNaN(n)) return '';
      const int = Math.floor(n);
      const intS = int.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      return intS;
    }

    function computeRowTotal(s){
      let sum=0;
      for(const d of dates){
        const v = s.values[d];
        const n = parseNumber(v);
        if(!isNaN(n)) sum+=n;
      }
      return sum;
    }

    function totalForDate(d){
      let sum=0;
      for(const s of students){
        const v = s.values[d];
        const n = parseNumber(v);
        if(!isNaN(n)) sum+=n;
      }
      return sum;
    }

    function overallTotal(){
      return students.reduce((sum,s)=>sum+computeRowTotal(s),0);
    }

    function loadAndRender(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try {
        const parsed = JSON.parse(raw);
        dates = parsed.dates || [];
        students = parsed.students || [];
        showTotals = parsed.showTotals || false;
      } catch(e){ console.warn('parse error'); }
      render();
    }

    function render(){
      tableHead.innerHTML = '';
      tableBody.innerHTML = '';
      tableFoot.innerHTML = '';

      // Header
      const trh = document.createElement('tr');
      trh.innerHTML = `<th class="name">Name</th>` + 
                      dates.map(d=>`<th>${fmtDateShort(d)}</th>`).join('') +
                      (showTotals ? `<th>Total</th>` : '');
      tableHead.appendChild(trh);

      // Body
      for(const s of students){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="name">${s.name}</td>` +
          dates.map(d=>`<td>${s.values[d] || ''}</td>`).join('') +
          (showTotals ? `<td class="row-total">${formatNumber(computeRowTotal(s))}</td>` : '');
        tableBody.appendChild(tr);
      }

      // Footer
      if(showTotals){
        const trf = document.createElement('tr');
        trf.innerHTML = `<td class="name">Overall Total</td>` +
          dates.map(d=>`<td>${formatNumber(totalForDate(d))}</td>`).join('') +
          `<td class="row-total">${formatNumber(overallTotal())}</td>`;
        tableFoot.appendChild(trf);
      }
    }

    // Watch for changes from index.html
    window.addEventListener('storage', (e)=>{
      if(e.key === LS_KEY) loadAndRender();
    });

    // Initial load
    loadAndRender();

    // Also refresh every 2s in case storage event doesn’t trigger (some browsers)
    setInterval(loadAndRender, 2000);
  </script>
</body>
</html>
